<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Caixa - Pizza Beneficente</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #A80000;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }

        .stat-card.pendente h3 { color: #ff9800; }
        .stat-card.confirmado h3 { color: #4caf50; }
        .stat-card.total h3 { color: #2196f3; }
        .stat-card.retirado h3 { color: #9c27b0; }

        .filters {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .filters select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .filters button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .filters button:hover {
            background: #5568d3;
        }

        .pedidos-list {
            display: grid;
            gap: 15px;
        }

        .pedido-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #ddd;
        }

        .pedido-card.pendente { border-left-color: #ff9800; }
        .pedido-card.confirmado { border-left-color: #4caf50; }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pedido-id {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-badge.pendente {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.confirmado {
            background: #d4edda;
            color: #155724;
        }

        .pedido-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .info-item strong {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .info-item span {
            font-size: 14px;
            color: #333;
        }

        .pedido-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-confirmar {
            background: #4caf50;
            color: white;
        }

        .btn-confirmar:hover {
            background: #45a049;
        }

        .btn-retirar {
            background: #2196f3;
            color: white;
        }

        .btn-retirar:hover {
            background: #0b7dda;
        }

        .btn-cancelar {
            background: #f44336;
            color: white;
        }

        .btn-cancelar:hover {
            background: #da190b;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .codigo-retirada {
            display: inline-block;
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
            padding: 10px 20px;
            background: #e8f5e9;
            border: 2px dashed #4caf50;
            border-radius: 5px;
            margin: 10px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçï Painel do Caixa</h1>
            <p>Igreja da Multiplica√ß√£o - Controle de Pedidos</p>
        </div>

        <div class="stats">
            <div class="stat-card pendente">
                <h3 id="stat-pendente">0</h3>
                <p>Pendentes</p>
            </div>
            <div class="stat-card confirmado">
                <h3 id="stat-confirmado">0</h3>
                <p>Confirmados</p>
            </div>
            <div class="stat-card retirado">
                <h3 id="stat-retirado">0</h3>
                <p>Retirados</p>
            </div>
            <div class="stat-card total">
                <h3 id="stat-total">R$ 0,00</h3>
                <p>Total Arrecadado</p>
            </div>
        </div>

        <div class="filters">
            <input type="text" id="search" placeholder="üîç Buscar por nome, telefone ou c√≥digo...">
            <select id="filter-status">
                <option value="TODOS">Todos os Status</option>
                <option value="PENDENTE">Pendentes</option>
                <option value="CONFIRMADO">Confirmados</option>
                <option value="RETIRADO">Retirados</option>
            </select>
            <select id="filter-vendedor">
                <option value="TODOS">Todos os Vendedores</option>
            </select>
            <button onclick="carregarPedidos()">üîÑ Atualizar</button>
        </div>

        <div id="pedidos-container">
            <div class="loading">Carregando pedidos...</div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="modal-confirmar" class="modal">
        <div class="modal-content">
            <h2>Confirmar Pagamento</h2>
            <p>Pedido: <strong id="modal-pedido-id"></strong></p>
            <p>Cliente: <strong id="modal-cliente"></strong></p>
            <p>Valor: <strong id="modal-valor"></strong></p>
            <input type="text" id="modal-comprovante" placeholder="Link ou n√∫mero do comprovante (opcional)">
            <div class="modal-actions">
                <button class="btn btn-cancelar" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-confirmar" onclick="confirmarPagamento()">‚úÖ Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Retirada -->
    <div id="modal-retirar" class="modal">
        <div class="modal-content">
            <h2>Confirmar Retirada</h2>
            <p>C√≥digo de retirada apresentado:</p>
            <input type="text" id="modal-codigo-retirada" placeholder="Digite o c√≥digo" style="text-transform: uppercase;">
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                Pedido: <strong id="modal-retirar-pedido"></strong><br>
                Cliente: <strong id="modal-retirar-cliente"></strong>
            </p>
            <div class="modal-actions">
                <button class="btn btn-cancelar" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-retirar" onclick="confirmarRetirada()">‚úÖ Confirmar Retirada</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURA√á√ïES ==========
        const CONFIG = {
            appsScriptUrl: "https://script.google.com/macros/s/AKfycbwf7bPHgL-oLa-hlsnpbbx6qnr7KzBhJOK2o4zGzf25T5UOK7ZaoiL9Ty-c6l0Iu6Q/exec",
            refreshInterval: 30000 // Atualizar a cada 30 segundos
        };

        const VENDEDORES = {
            "ROSIDE01": "Roside Jose",
            "MIRIAM02": "Miriam Amorim",
            "LUCIANO03": "Luciano Silva",
            "JANAINA04": "Janaina Silva",
            "RENATO05": "Renato",
            "GUARANICE06": "Guaranice",
            "DIRETO": "Venda Direta"
        };

        let pedidos = [];
        let pedidoSelecionado = null;

        // ========== CARREGAR PEDIDOS ==========
        function carregarPedidos() {
            console.log("üîÑ Carregando pedidos da planilha...");
            
            // Buscar pedidos reais do Google Sheets
            fetch(CONFIG.appsScriptUrl + '?action=listar')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.pedidos) {
                        pedidos = data.pedidos;
                        console.log(`‚úÖ ${pedidos.length} pedidos carregados`);
                    } else {
                        console.log("‚ö†Ô∏è Nenhum pedido encontrado");
                        pedidos = [];
                    }
                    renderizarPedidos();
                    atualizarEstatisticas();
                    popularFiltroVendedor();
                })
                .catch(error => {
                    console.error("‚ùå Erro ao carregar pedidos:", error);
                    // Manter pedidos anteriores se houver erro
                    renderizarPedidos();
                    atualizarEstatisticas();
                    popularFiltroVendedor();
                });
        }

        // ========== RENDERIZAR PEDIDOS ==========
        function renderizarPedidos() {
            const container = document.getElementById('pedidos-container');
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const vendedorFilter = document.getElementById('filter-vendedor').value;

            let pedidosFiltrados = pedidos.filter(p => {
                const matchSearch = p.nome.toLowerCase().includes(searchTerm) ||
                                  p.telefone.includes(searchTerm) ||
                                  p.pedido_id.toLowerCase().includes(searchTerm) ||
                                  (p.codigo_retirada && p.codigo_retirada.toLowerCase().includes(searchTerm));
                
                let matchStatus = false;
                if (statusFilter === 'TODOS') {
                    matchStatus = true;
                } else if (statusFilter === 'PENDENTE') {
                    matchStatus = p.status_pagamento === 'PENDENTE';
                } else if (statusFilter === 'CONFIRMADO') {
                    matchStatus = p.status_pagamento === 'CONFIRMADO' && p.status_retirada !== 'RETIRADO';
                } else if (statusFilter === 'RETIRADO') {
                    matchStatus = p.status_retirada === 'RETIRADO';
                }
                
                const matchVendedor = vendedorFilter === 'TODOS' || p.vendedor_codigo === vendedorFilter;

                return matchSearch && matchStatus && matchVendedor;
            });

            // Ordenar: pendentes primeiro
            pedidosFiltrados.sort((a, b) => {
                if (a.status_pagamento === 'PENDENTE' && b.status_pagamento !== 'PENDENTE') return -1;
                if (a.status_pagamento !== 'PENDENTE' && b.status_pagamento === 'PENDENTE') return 1;
                return 0;
            });

            if (pedidosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üì≠ Nenhum pedido encontrado</h3>
                        <p>Tente ajustar os filtros de busca</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<div class="pedidos-list">${pedidosFiltrados.map(pedido => `
                <div class="pedido-card ${pedido.status_pagamento.toLowerCase()}">
                    <div class="pedido-header">
                        <div class="pedido-id">${pedido.pedido_id}</div>
                        <div class="status-badge ${pedido.status_retirada === 'RETIRADO' ? 'confirmado' : pedido.status_pagamento.toLowerCase()}">
                            ${pedido.status_retirada === 'RETIRADO' ? '‚úÖ RETIRADO' : pedido.status_pagamento}
                        </div>
                    </div>

                    <div class="pedido-info">
                        <div class="info-item">
                            <strong>üë§ CLIENTE</strong>
                            <span>${pedido.nome}</span>
                        </div>
                        <div class="info-item">
                            <strong>üì± TELEFONE</strong>
                            <span>${pedido.telefone}</span>
                        </div>
                        <div class="info-item">
                            <strong>üìç ENDERE√áO</strong>
                            <span>${pedido.endereco}</span>
                        </div>
                        <div class="info-item">
                            <strong>üçï PIZZAS</strong>
                            <span>${pedido.qtd_mista > 0 ? pedido.qtd_mista + 'x Mista ' : ''}${pedido.qtd_frango > 0 ? pedido.qtd_frango + 'x Frango' : ''}</span>
                        </div>
                        <div class="info-item">
                            <strong>üí∞ VALOR</strong>
                            <span>R$ ${pedido.valor_total.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="info-item">
                            <strong>üë• VENDEDOR</strong>
                            <span>${pedido.vendedor_nome}</span>
                        </div>
                        <div class="info-item">
                            <strong>üìÖ DATA</strong>
                            <span>${pedido.data_pedido}</span>
                        </div>
                    </div>

                    ${pedido.codigo_retirada ? `
                        <div style="text-align: center; margin: 10px 0;">
                            <strong>C√≥digo de Retirada:</strong><br>
                            <div class="codigo-retirada">${pedido.codigo_retirada}</div>
                        </div>
                    ` : ''}

                    <div class="pedido-actions">
                        ${pedido.status_pagamento === 'PENDENTE' ? `
                            <button class="btn btn-confirmar" onclick="abrirModalConfirmar('${pedido.pedido_id}')">
                                ‚úÖ Confirmar Pagamento
                            </button>
                        ` : ''}
                        
                        ${pedido.status_pagamento === 'CONFIRMADO' && pedido.status_retirada !== 'RETIRADO' ? `
                            <button class="btn btn-retirar" onclick="abrirModalRetirar('${pedido.pedido_id}')">
                                üì¶ Registrar Retirada
                            </button>
                        ` : ''}

                        ${pedido.status_retirada === 'RETIRADO' ? `
                            <div style="flex: 1; text-align: center; padding: 12px; background: #e8f5e9; border-radius: 5px; color: #2e7d32; font-weight: bold;">
                                ‚úÖ Pizza retirada em ${pedido.data_retirada || 'data n√£o registrada'}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('')}</div>`;
        }

        // ========== ESTAT√çSTICAS ==========
        function atualizarEstatisticas() {
            const pendentes = pedidos.filter(p => p.status_pagamento === 'PENDENTE').length;
            const confirmados = pedidos.filter(p => p.status_pagamento === 'CONFIRMADO' && p.status_retirada !== 'RETIRADO').length;
            const retirados = pedidos.filter(p => p.status_retirada === 'RETIRADO').length;
            const totalArrecadado = pedidos
                .filter(p => p.status_pagamento === 'CONFIRMADO')
                .reduce((sum, p) => sum + p.valor_total, 0);

            document.getElementById('stat-pendente').textContent = pendentes;
            document.getElementById('stat-confirmado').textContent = confirmados;
            document.getElementById('stat-retirado').textContent = retirados;
            document.getElementById('stat-total').textContent = `R$ ${totalArrecadado.toFixed(2).replace('.', ',')}`;
        }

        // ========== POPULAR FILTRO DE VENDEDOR ==========
        function popularFiltroVendedor() {
            const select = document.getElementById('filter-vendedor');
            const vendedoresUnicos = [...new Set(pedidos.map(p => p.vendedor_codigo))];
            
            select.innerHTML = '<option value="TODOS">Todos os Vendedores</option>';
            vendedoresUnicos.forEach(codigo => {
                select.innerHTML += `<option value="${codigo}">${VENDEDORES[codigo] || codigo}</option>`;
            });
        }

        // ========== MODALS ==========
        function abrirModalConfirmar(pedidoId) {
            pedidoSelecionado = pedidos.find(p => p.pedido_id === pedidoId);
            if (!pedidoSelecionado) return;

            document.getElementById('modal-pedido-id').textContent = pedidoId;
            document.getElementById('modal-cliente').textContent = pedidoSelecionado.nome;
            document.getElementById('modal-valor').textContent = `R$ ${pedidoSelecionado.valor_total.toFixed(2).replace('.', ',')}`;
            document.getElementById('modal-comprovante').value = '';
            
            document.getElementById('modal-confirmar').classList.add('active');
        }

        function abrirModalRetirar(pedidoId) {
            pedidoSelecionado = pedidos.find(p => p.pedido_id === pedidoId);
            if (!pedidoSelecionado) return;

            document.getElementById('modal-retirar-pedido').textContent = pedidoId;
            document.getElementById('modal-retirar-cliente').textContent = pedidoSelecionado.nome;
            document.getElementById('modal-codigo-retirada').value = '';
            
            document.getElementById('modal-retirar').classList.add('active');
        }

        function fecharModal() {
            document.getElementById('modal-confirmar').classList.remove('active');
            document.getElementById('modal-retirar').classList.remove('active');
            pedidoSelecionado = null;
        }

        // ========== CONFIRMAR PAGAMENTO ==========
        function confirmarPagamento() {
            if (!pedidoSelecionado) return;

            const comprovante = document.getElementById('modal-comprovante').value;
            const codigoRetirada = gerarCodigoRetirada();

            // Atualizar localmente
            pedidoSelecionado.status_pagamento = 'CONFIRMADO';
            pedidoSelecionado.codigo_retirada = codigoRetirada;
            pedidoSelecionado.data_confirmacao = new Date().toLocaleString('pt-BR');
            pedidoSelecionado.comprovante = comprovante;

            // ENVIAR PARA APPS SCRIPT
            console.log('Confirmando pagamento:', pedidoSelecionado);
            
            fetch(CONFIG.appsScriptUrl + '?action=confirmar', {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pedidoSelecionado)
            }).then(() => {
                console.log("‚úÖ Pagamento confirmado na planilha");
                fecharModal();
                renderizarPedidos();
                atualizarEstatisticas();
                alert(`‚úÖ Pagamento confirmado!\n\nC√≥digo de retirada: ${codigoRetirada}\n\nEnvie este c√≥digo para o cliente via WhatsApp.`);
            }).catch(error => {
                console.error("‚ùå Erro:", error);
                fecharModal();
                renderizarPedidos();
                atualizarEstatisticas();
                alert(`‚úÖ Pagamento confirmado!\n\nC√≥digo de retirada: ${codigoRetirada}\n\nEnvie este c√≥digo para o cliente via WhatsApp.`);
            });
        }

        // ========== CONFIRMAR RETIRADA ==========
        function confirmarRetirada() {
            if (!pedidoSelecionado) return;

            const codigoDigitado = document.getElementById('modal-codigo-retirada').value.trim().toUpperCase();
            
            if (codigoDigitado !== pedidoSelecionado.codigo_retirada) {
                alert('‚ùå C√≥digo de retirada incorreto!');
                return;
            }

            // Atualizar localmente
            pedidoSelecionado.status_retirada = 'RETIRADO';
            pedidoSelecionado.data_retirada = new Date().toLocaleString('pt-BR');

            // ENVIAR PARA APPS SCRIPT
            console.log('Registrando retirada:', pedidoSelecionado);
            
            fetch(CONFIG.appsScriptUrl + '?action=retirar', {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pedidoSelecionado)
            }).then(() => {
                console.log("‚úÖ Retirada registrada na planilha");
                fecharModal();
                renderizarPedidos();
                atualizarEstatisticas();
                alert('‚úÖ Retirada confirmada com sucesso!');
            }).catch(error => {
                console.error("‚ùå Erro:", error);
                fecharModal();
                renderizarPedidos();
                atualizarEstatisticas();
                alert('‚úÖ Retirada confirmada com sucesso!');
            });
        }

        // ========== GERAR C√ìDIGO ==========
        function gerarCodigoRetirada() {
            return 'PZ-' + Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        // ========== FILTROS ==========
        document.getElementById('search').addEventListener('input', renderizarPedidos);
        document.getElementById('filter-status').addEventListener('change', renderizarPedidos);
        document.getElementById('filter-vendedor').addEventListener('change', renderizarPedidos);

        // ========== FECHAR MODAL COM ESC ==========
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') fecharModal();
        });

        // ========== INICIALIZA√á√ÉO ==========
        carregarPedidos();
        
        // Auto-refresh
        setInterval(carregarPedidos, CONFIG.refreshInterval);
    </script>
</body>
</html>